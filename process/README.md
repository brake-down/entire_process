# 🚗 실시간 페달 오작동 감지 시스템 (Python)

본 시스템은 **운전자 음성, 영상, 차량 OBD2 데이터**를 융합하여  
페달 오작동 여부를 실시간으로 감지하고 **정상 → WARNING → ALERT** 단계로 로그를 출력하는 구조이다.

---

## ⚙️ 전체 구조
- **입력(Producer)**: Audio, Video, Serial(OBD2) 모듈에서 확률/센서 값 입력
- **큐(Queue)**: 입력 메시지를 저장하여 비동기 처리
- **소비자(Consumer)**: 최근 버퍼 기반으로 판단 로직 실행
- **출력(Logger)**: 경고·알림 상황을 JSON 로그로 기록

---

## 🧩 주요 컴포넌트 설명

### 1. 설정(Config)
- **Config 데이터클래스**에 파라미터들을 모아 관리  
  - 오디오/비디오 임계값, OBD 비정상 조건 기준치, 쿨다운 시간 등  
- 장점: 임계값/주기 등을 한 곳에서 수정 가능 → **튜닝 용이**

---

### 2. 메시지 구조(Msg, MsgType)
- **MsgType(Enum)**: AUDIO, VIDEO, SERIAL(OBD2) 구분
- **Msg 클래스**: 각 데이터의 타입, 타임스탬프, 실제 값, 메타정보를 담음  
- 장점: 입력 형식을 통합하여 **모듈 간 확장성↑, 유지보수성↑**

---

### 3. 유틸리티 함수
- **버퍼 관리**: 오래된 데이터를 자동 제거하여 최근 창(window)만 유지
- **recent_values / peak / count_over**: 최근 특정 키 값 통계 추출
- **delta_over_window**: 최근 값의 변화량 계산  
- 장점: 실시간 스트림에서도 **효율적으로 최근 데이터만 분석 가능**

---

### 4. Producer (입력부)
- **audio_producer()**  
  - 외부에서 `audio_surprise_prob`(놀람 확률) 값을 받아오는 역할  
  - 현재는 `random` 기반으로 모의 데이터 생성

- **video_producer()**  
  - 외부에서 `face_surprise_prob` 값을 받아오는 역할  
  - 현재는 랜덤 값 기반 시뮬레이션

- **serial_producer()**  
  - 차량 OBD2(속도, rpm, 스로틀, 브레이크 등) 값을 받아오는 역할  
  - 현재는 랜덤 기반 모의 데이터 + 일부 비정상 상황(브레이크+스로틀 동시) 삽입

👉 장점: 실제 장치 입력이 없어도 **시뮬레이션 기반 테스트 가능**

---

### 5. FusionState (버퍼 상태)
- 최근 일정 시간(`horizon`) 동안 Audio/Video/Serial 데이터를 각각 저장  
- 오래된 데이터는 자동 삭제  
- 장점: 여러 입력을 시간 축으로 정렬·관리하여 **멀티모달 융합 처리에 최적화**

---

### 6. OBD 이상 감지 (is_obd_abnormal)
- 조건 예시:
  - 브레이크와 스로틀 동시 입력
  - 스로틀은 높지만 속도는 거의 없음
  - 중립 기어에서 과도한 가속
  - rpm은 급등했는데 속도 변화는 거의 없음  
- 장점: **실제 차량 이상 신호를 단순 규칙으로도 빠르게 감지**

---

### 7. 최종 의사결정 (decide)
- 입력: FusionState, 마지막 ALERT 발생 시간  
- 출력: 결정(OK / WARNING / ALERT), 이유, 점수, 스냅샷  
- 규칙:
  - OBD 이상 + 운전자 놀람 **지속성** → ALERT
  - OBD 이상 + 운전자 놀람 **피크** → WARNING
  - 그 외 → OK
  - ALERT 후 쿨다운 시간 내에는 억제  
- 장점: **사람 반응과 차량 상태를 융합**하여 신뢰성 있는 판단 가능

---

### 8. 로깅/출력 (emit_event)
- 판단 결과를 JSON 형태로 출력 (콘솔 & 파일)  
- 장점: 로그 기반 후처리, 분석, UI 시각화 가능

---

### 9. 테스트 시나리오 (test_scenario_producer)
- 순차적으로 상황을 발생시킴:
  1. 정상(OK) → 3초
  2. WARNING (OBD 이상 + 오디오 피크) → 0.5초
  3. ALERT (OBD 이상 + 오디오 지속성) → 2초  
- 장점: 실제 센서 없이도 **정상→경고→위험** 흐름을 강제로 시뮬레이션 가능

---

### 10. 메인 루프(main, decision_loop)
- Producer와 Consumer 스레드를 실행  
- 실시간으로 큐에 데이터가 쌓이고 판단 루프에서 소비  
- Ctrl+C로 종료 가능  
- 장점: **멀티스레딩 구조**로 실제 센서·카메라·마이크 입력을 병렬 처리 가능

---
